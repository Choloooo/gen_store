{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Dashboard</h1>

    <!-- Search Bar and Button -->
    <form method="GET" action="{% url 'dashboard' %}" id="searchForm">
        <div class="d-flex justify-content-between mb-4">
            <div class="input-group w-50">
                <!-- Search input -->
                <input type="text" id="searchInput" name="q" class="form-control" 
                    value="{{ query }}" placeholder="Search for items..." 
                    oninput="handleSearchInput()">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </div>
    </form>

    <!-- Button to open Add Item modal -->
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
        <i class="bi bi-plus-circle"></i> Add New Item
    </button>

    <!-- Button to trigger QR Code scanning -->
    <button type="button" class="btn btn-primary" onclick="window.open('{% url 'qr_scanner' %}', '_blank', 'width=800,height=600')">
        <i class="bi bi-camera"></i> Scan QR Code
    </button>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">Add New Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{% url 'add_item' %}">
                        {% csrf_token %}
                        {{ form.as_p }}
                        {% if form.errors %}
                            <div class="alert alert-danger mt-3">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <p>{{ field.label }}: {{ error }}</p>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <button type="submit" class="btn btn-primary mt-3">Add Item</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Scan Modal -->
    <div class="modal fade" id="scanQrModal" tabindex="-1" aria-labelledby="scanQrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scanQrModalLabel">Scan QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- QR Code Reader container -->
                    <div id="reader" style="width: 100%; height: 400px;"></div>
                    <p id="qr-result" class="mt-3">Scan a QR Code to see the result here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- List of items -->
    <table class="table mt-5">
        <thead>
            <tr>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="itemTable">
            {% for item in page_obj %}
            <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>
                    <a href="{% url 'edit_item' item.id %}" class="btn btn-warning">Edit</a>
                    <a href="{% url 'delete_item' item.id %}" class="btn btn-danger">Delete</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">No items found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="pagination mt-4 d-flex justify-content-center">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?q={{ query }}&page=1" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span> First
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?q={{ query }}&page={{ page_obj.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span> Previous
                        </a>
                    </li>
                {% endif %}

                <li class="page-item disabled">
                    <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                </li>

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?q={{ query }}&page={{ page_obj.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span> Next
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?q={{ query }}&page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span> Last
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

<!-- Include necessary scripts first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Function to handle the search input change
    function handleSearchInput() {
        var handleSearchInput = ""
        let searchInput = document.getElementById('searchInput');
        let query = searchInput.value;

        // If the input is empty, reset the query and reload the page
        if (query === "") {
            window.location.href = "{% url 'dashboard' %}";  // No query parameter
        }
    }
</script>

<script>
    // QR Code Scanner logic
    let html5QrcodeScanner;

    // Function to start the QR code scanner
    function startQrScanner() {
        console.log("Starting QR Code Scanner...");

        // Callback for successfully decoded QR code
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            console.log("QR Code Detected: ", decodedText); // Debugging output
            document.getElementById('qr-result').innerText = 'QR Code Result: ' + decodedText;
            // Optionally stop scanning after the first QR code is detected
            html5QrcodeScanner.stop().then(() => {
                console.log("QR Code Scanner Stopped");
            }).catch((err) => {
                console.log("Error stopping the scanner: ", err);
            });
        };

        // Callback for errors
        const qrCodeErrorCallback = (errorMessage) => {
            console.log("QR Scanner Error: ", errorMessage); // Debugging output
        };

        // Initialize the QR Code reader
        html5QrcodeScanner = new Html5Qrcode("reader");

        // Start scanning
        html5QrcodeScanner.start(
            { facingMode: "environment" }, // Use the back camera
            {
                fps: 10, // Frames per second for scanning
                qrbox: 250 // Size of the scanning box
            },
            qrCodeSuccessCallback,
            qrCodeErrorCallback
        ).catch((err) => {
            console.log("Error starting QR scanner:", err); // Debugging output
        });
    }

    // When the QR scan modal is shown, start scanning
    $('#scanQrModal').on('shown.bs.modal', function () {
        console.log("Modal is shown, starting the QR scanner.");
        // Wait a short moment for the modal to finish rendering before starting the scanner
        setTimeout(startQrScanner, 500);
    });

    // When the modal is hidden, stop the scanner
    $('#scanQrModal').on('hidden.bs.modal', function () {
        console.log("Modal is hidden, stopping the QR scanner.");
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                console.log("QR Code Scanner Stopped");
            }).catch((err) => {
                console.log("Error stopping the scanner: ", err);
            });
        }
    });
</script>

<!-- Optional: Custom CSS for pagination and buttons -->
<style>
    .pagination .page-link {
        border-radius: 0.25rem;
        font-weight: 500;
        color: #007bff;
    }
    .pagination .page-link:hover {
        background-color: #007bff;
        color: white;
    }
    .pagination .page-item.disabled .page-link {
        color: #6c757d;
    }
    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }
</style>
